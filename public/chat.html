<script>
const PRODUCTS_PER_PAGE = 50;
let allProducts = [];
let currentPage = 0;

// Send AI request for category
async function sendQuickMessage(category) {
  appendMessage('user', `Show me ${category} products`);
  appendMessage('bot', '✨ Thinking...');

  try {
    const res = await fetch('https://beauty-ai-backend.onrender.com/ask-claude', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ category })
    });

    const data = await res.json();
    if (data.products && data.products.length > 0) {
      allProducts = data.products;
      currentPage = 0;
      updateLastBotMessage(`Here are top ${category} products:`);
      renderProducts();
    } else {
      // Fallback to Rainforest
      fetchFallback(category);
    }
  } catch (err) {
    updateLastBotMessage('❌ AI error. Trying Amazon...');
    fetchFallback(category);
  }
}

async function fetchFallback(category) {
  try {
    const res = await fetch('https://beauty-ai-backend.onrender.com/fallback-products', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ category })
    });

    const data = await res.json();
    if (data.products && data.products.length > 0) {
      allProducts = data.products;
      currentPage = 0;
      updateLastBotMessage(`Fallback data loaded for ${category}:`);
      renderProducts();
    } else {
      updateLastBotMessage('❌ No products found.');
    }
  } catch (err) {
    updateLastBotMessage('❌ Could not load products.');
  }
}

function renderProducts() {
  const container = document.getElementById('chatArea');
  const grid = document.createElement('div');
  grid.className = 'products-grid';

  const start = currentPage * PRODUCTS_PER_PAGE;
  const end = start + PRODUCTS_PER_PAGE;
  const pageProducts = allProducts.slice(start, end);

  pageProducts.forEach(p => {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.innerHTML = `
      <div class="product-image"><img src="${p.image}" alt="${p.name}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;"></div>
      <div class="product-name">${p.name}</div>
      <div class="product-brand">${p.description}</div>
      <div class="product-price">${p.price}</div>
      <button class="add-to-cart-btn" onclick="addToCart('${p.name}')">Add to Cart</button>
    `;
    grid.appendChild(card);
  });

  container.appendChild(grid);

  if (end < allProducts.length) {
    const loadMoreBtn = document.createElement('button');
    loadMoreBtn.textContent = 'Load More';
    loadMoreBtn.className = 'refresh-btn';
    loadMoreBtn.onclick = () => {
      currentPage++;
      renderProducts();
    };
    container.appendChild(loadMoreBtn);
  }

  const homeBtn = document.createElement('button');
  homeBtn.textContent = 'Return Home';
  homeBtn.className = 'refresh-btn';
  homeBtn.onclick = () => location.href = 'index.html';
  container.appendChild(homeBtn);
}

function addToCart(name) {
  alert(`Added ${name} to cart!`);
}

function appendMessage(sender, text) {
  const msgBox = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = `message ${sender}`;
  div.innerHTML = `<div class="message-content">${text}</div>`;
  msgBox.appendChild(div);
  msgBox.scrollTop = msgBox.scrollHeight;
}

function updateLastBotMessage(text) {
  const msgs = document.querySelectorAll('.message.bot .message-content');
  if (msgs.length) {
    msgs[msgs.length - 1].textContent = text;
  }
}
</script>
