<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport"/>
<title>Beauty Chat - Luminous AI</title>
<style>
body { font-family: Arial, sans-serif; background:#2C2C2C; color:#fff; margin:0; }
.container { max-width:414px; margin:auto; display:flex; flex-direction:column; height:100vh; }
.header { background:#2C2C2C; padding:15px; text-align:center; font-weight:bold; }
.chat-area { flex:1; background:#F8F8F8; color:#333; padding:15px; overflow-y:auto; }
.message { margin-bottom:10px; display:flex; }
.message.user { justify-content:flex-end; }
.message-content { background:white; padding:10px; border-radius:12px; max-width:75%; }
.message.user .message-content { background:linear-gradient(135deg,#B8860B,#DAA520); color:white; }
.product-card { background:#fff; border-radius:12px; padding:12px; margin-bottom:10px; border:1px solid #eee; }
.product-name { font-weight:bold; }
.show-more { background:#B8860B; color:white; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer; margin-top:10px; }
.input-area { background:#2C2C2C; padding:10px; }
.input-container { display:flex; gap:10px; background:white; border-radius:25px; padding:10px; }
.message-input { flex:1; border:none; outline:none; }
.send-btn { background:linear-gradient(135deg,#B8860B,#DAA520); border:none; color:white; border-radius:50%; width:40px; height:40px; cursor:pointer; }
</style>
</head>
<body>
<div class="container">
  <div class="header">✨ Beauty Chat</div>
  <div id="chatArea" class="chat-area">
    <div class="message bot"><div class="message-content">Hi! Ask me about beauty products or click a category.</div></div>
  </div>
  <div class="input-area">
    <div class="input-container">
      <input id="messageInput" class="message-input" placeholder="Ask about beauty products..." onkeypress="handleKey(event)"/>
      <button class="send-btn" onclick="sendMessage()">▶</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://beauty-ai-backend.onrender.com/ask-claude";
let currentQuery = "";
let currentPage = 1;

async function sendMessage() {
  const input = document.getElementById("messageInput");
  const message = input.value.trim();
  if (!message) return;

  appendMessage("user", message);
  input.value = "";
  currentQuery = message;
  currentPage = 1;
  document.getElementById("chatArea").innerHTML = ""; // Clear previous
  appendMessage("bot", "✨ Thinking...");
  await fetchProducts();
}

async function fetchProducts() {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category: currentQuery, page: currentPage })
    });
    const data = await res.json();
    updateLastBotMessage("Here are some products:");
    renderProducts(data.products);
    if (data.products.length === 50) addShowMore();
  } catch {
    updateLastBotMessage("❌ Failed to load products.");
  }
}

function appendMessage(sender, text) {
  const chat = document.getElementById("chatArea");
  const div = document.createElement("div");
  div.className = `message ${sender}`;
  div.innerHTML = `<div class="message-content">${text}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function updateLastBotMessage(text) {
  const botMsgs = document.querySelectorAll(".message.bot .message-content");
  if (botMsgs.length) botMsgs[botMsgs.length - 1].textContent = text;
}

function renderProducts(products) {
  const chat = document.getElementById("chatArea");
  products.forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `<div class="product-name">${p.name}</div>
      <div>${p.description}</div>
      <div style="color:#B8860B;font-weight:bold;">${p.price || "$?"}</div>`;
    chat.appendChild(card);
  });
  chat.scrollTop = chat.scrollHeight;
}

function addShowMore() {
  if (document.getElementById("showMoreBtn")) return;
  const btn = document.createElement("button");
  btn.id = "showMoreBtn";
  btn.className = "show-more";
  btn.textContent = "Show More";
  btn.onclick = () => {
    currentPage++;
    btn.remove();
    fetchProducts();
  };
  document.getElementById("chatArea").appendChild(btn);
}

function handleKey(e) {
  if (e.key === "Enter") sendMessage();
}

// Auto-load if query in URL
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get("query")) {
  currentQuery = urlParams.get("query");
  appendMessage("bot", `✨ Loading products for "${currentQuery}"...`);
  fetchProducts();
}
</script>
</body>
</html>
