<script>
const BACKEND_URL = "https://beauty-ai-backend.onrender.com";

let currentCategory = "";
let offset = 0;
const count = 20;

function sendMessage() {
  const input = document.getElementById('messageInput');
  const message = input.value.trim();
  if (!message) return;

  currentCategory = message;
  offset = 0;

  clearProducts();
  appendMessage('user', message);
  input.value = '';
  appendMessage('bot', '✨ Thinking...');

  fetchProducts();
}

function fetchProducts() {
  fetch(`${BACKEND_URL}/ask-claude`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ category: currentCategory, offset, count })
  })
  .then(res => res.json())
  .then(data => {
    if (data.products && data.products.length > 0) {
      updateLastBotMessage('Here are some recommendations:');
      showProducts(data.products);
      offset += count;
      toggleShowMore(true);
    } else {
      updateLastBotMessage('❌ No products found.');
      toggleShowMore(false);
    }
  })
  .catch(() => {
    updateLastBotMessage('❌ AI service error. Try again.');
  });
}

function showProducts(products) {
  const msgBox = document.getElementById('chatArea');
  const container = document.createElement('div');
  products.forEach(p => {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.innerHTML = `
      <div class="product-name">${p.name}</div>
      <div class="product-price">${p.price || '$?'}</div>
      <div>${p.description || ''}</div>
    `;
    container.appendChild(card);
  });
  msgBox.appendChild(container);
  msgBox.scrollTop = msgBox.scrollHeight;
}

function appendMessage(sender, text) {
  const msgBox = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = `message ${sender}`;
  div.innerHTML = `<div class="message-content">${text}</div>`;
  msgBox.appendChild(div);
  msgBox.scrollTop = msgBox.scrollHeight;
}

function updateLastBotMessage(text) {
  const msgs = document.querySelectorAll('.message.bot .message-content');
  if (msgs.length) {
    msgs[msgs.length - 1].textContent = text;
  }
}

function clearProducts() {
  const msgBox = document.getElementById('chatArea');
  msgBox.innerHTML = '';
}

function toggleShowMore(show) {
  const btn = document.getElementById('showMoreBtn');
  btn.style.display = show ? 'block' : 'none';
}

function showMore() {
  appendMessage('bot', '✨ Loading more products...');
  fetchProducts();
}

function handleKeyPress(e) {
  if (e.key === 'Enter') sendMessage();
}

function sendQuickMessage(text) {
  document.getElementById('messageInput').value = text;
  sendMessage();
}
</script>

<div style="text-align:center;margin:15px;">
  <button id="showMoreBtn" style="display:none;padding:10px 20px;background:#B8860B;color:#fff;border:none;border-radius:8px;cursor:pointer;" onclick="showMore()">Show More</button>
</div>
