<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Test Pagination</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button {
            padding: 12px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .debug {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Test Pagination - Fix Size Limits</h1>
    
    <div class="container">
        <h2>üß™ Pagination Tests</h2>
        <p>These tests check if pagination fixes the "Content-Length exceeds response Body" error.</p>
        
        <button onclick="testPaginationPage1()">Test Page 1 (1000 products)</button>
        <button onclick="testPaginationPage2()">Test Page 2 (next 1000)</button>
        <button onclick="testSmallLimit()">Test Small Limit (100 products)</button>
        <button onclick="testApiKeys()">Check API Keys</button>
        <button onclick="clearResults()">Clear</button>
    </div>
    
    <div id="results"></div>
    
    <div class="container">
        <h3>Debug Log</h3>
        <div id="debug" class="debug">Ready to test pagination...\n</div>
    </div>

    <script>
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        const API_URL = 'https://beauty-ai-backend.onrender.com';
        
        const debugElement = document.getElementById('debug');
        const resultsElement = document.getElementById('results');
        
        function log(message) {
            debugElement.textContent += `${new Date().toLocaleTimeString()} ${message}\n`;
            debugElement.scrollTop = debugElement.scrollHeight;
        }

        function addResult(title, data, type = 'info') {
            const div = document.createElement('div');
            div.className = `container ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre style="white-space: pre-wrap; font-size: 12px;">${JSON.stringify(data, null, 2)}</pre>
            `;
            resultsElement.appendChild(div);
        }

        function clearResults() {
            resultsElement.innerHTML = '';
            debugElement.textContent = 'Debug cleared...\n';
        }

        // Test pagination with small sizes
        async function testPaginationPage1() {
            log('üîç Testing pagination page 1 (300 products max)...');
            
            try {
                const url = `${CORS_PROXY}${encodeURIComponent(API_URL + '/api/products/search?q=global&page=1&limit=300')}`;
                log(`Request: Page 1, Limit 300`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                log(`‚úÖ Page 1 SUCCESS: ${data.products?.length || 0} products`);
                log(`üìä Pagination: ${data.pagination?.currentPage}/${data.pagination?.totalPages} pages`);
                log(`üìà Total available: ${data.pagination?.totalProducts || 'unknown'}`);
                log(`üåç Sources: ${data.stats?.source || 'unknown'}`);
                
                addResult('‚úÖ Page 1 Test - SUCCESS', {
                    productsReturned: data.products?.length || 0,
                    pagination: data.pagination,
                    stats: data.stats,
                    status: 'Smaller pagination working!',
                    geminiCount: data.stats?.geminiCount || 0,
                    rainforestCount: data.stats?.rainforestCount || 0,
                    localCount: data.stats?.localCount || 0
                }, 'success');
                
            } catch (error) {
                log(`‚ùå Page 1 failed: ${error.message}`);
                
                if (error.message.includes('Content-Length')) {
                    addResult('‚ùå Page 1 - Still Too Large', {
                        error: error.message,
                        status: 'Need even smaller limit'
                    }, 'error');
                } else {
                    addResult('‚ùå Page 1 - Other Error', {
                        error: error.message
                    }, 'error');
                }
            }
        }

        // Test pagination page 2
        async function testPaginationPage2() {
            log('üîç Testing pagination page 2 (300 products max)...');
            
            try {
                const url = `${CORS_PROXY}${encodeURIComponent(API_URL + '/api/products/search?q=global&page=2&limit=300')}`;
                log(`Request: Page 2, Limit 300`);
                
                const response = await fetch(url);
                const data = await response.json();
                
                log(`‚úÖ Page 2 SUCCESS: ${data.products?.length || 0} products`);
                log(`üìä Different products from page 1: ${data.products?.[0]?.name || 'unknown'}`);
                
                addResult('‚úÖ Page 2 Test - SUCCESS', {
                    productsReturned: data.products?.length || 0,
                    pagination: data.pagination,
                    firstProduct: data.products?.[0]?.name || 'none',
                    status: 'Multiple pages working!'
                }, 'success');
                
            } catch (error) {
                log(`‚ùå Page 2 failed: ${error.message}`);
                addResult('‚ùå Page 2 Test', { error: error.message }, 'error');
            }
        }

        // Test small limit
        async function testSmallLimit() {
            log('üîç Testing small limit (100 products)...');
            
            try {
                const url = `${CORS_PROXY}${encodeURIComponent(API_URL + '/api/products/search?q=global&page=1&limit=100')}`;
                log(`Request: Page 1, Limit 100`);
                
                const response = await fetch(url);
                const data = await response.json();
                
                log(`‚úÖ Small limit SUCCESS: ${data.products?.length || 0} products`);
                
                addResult('‚úÖ Small Limit Test - SUCCESS', {
                    productsReturned: data.products?.length || 0,
                    pagination: data.pagination,
                    status: 'Small responses work fine!'
                }, 'success');
                
            } catch (error) {
                log(`‚ùå Small limit failed: ${error.message}`);
                addResult('‚ùå Small Limit Test', { error: error.message }, 'error');
            }
        }

        // Test API keys
        async function testApiKeys() {
            log('üîë Testing API keys...');
            
            try {
                const url = `${CORS_PROXY}${encodeURIComponent(API_URL + '/debug/keys')}`;
                const response = await fetch(url);
                const data = await response.json();
                
                log(`üîë API Keys: Rainforest=${data.rainforestEnabled}, Gemini=${data.geminiEnabled}`);
                
                const keysWorking = data.rainforestEnabled || data.geminiEnabled;
                
                addResult(keysWorking ? '‚úÖ API Keys - Some Working' : '‚ùå API Keys - All Disabled', {
                    rainforestEnabled: data.rainforestEnabled,
                    geminiEnabled: data.geminiEnabled,
                    rainforestKeyLength: data.rainforestKeyLength,
                    geminiKeyLength: data.geminiKeyLength,
                    status: keysWorking ? 'At least one API key is working' : 'No API keys detected'
                }, keysWorking ? 'success' : 'error');
                
            } catch (error) {
                log(`‚ùå API keys test failed: ${error.message}`);
                addResult('‚ùå API Keys Test', { error: error.message }, 'error');
            }
        }

        window.addEventListener('load', function() {
            log('üöÄ Pagination test ready');
            log('This will test if pagination fixes the response size issue');
        });
    </script>
</body>
</html>
